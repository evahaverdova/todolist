{% extends 'base_generic.html' %}
{% load static %}

{% block content %}
<div class="task-container">
    <div class="header">
        <div class="task-header-actions">
            <h2 class="task-header">Task List</h2>
            <div id="task-filters" class="task-filters">
                <div class="filter-wrapper">
                    <button onclick="window.location.href='?filter=all'" class="filter-button {% if current_filter == 'all' %}active{% endif %}">All</button>
                </div>
                {% for filter in available_statuses %}
                    {% if filter != 'all' %}
                        <div class="filter-wrapper">
                            <button onclick="window.location.href='?filter={{ filter }}'" class="filter-button {% if current_filter == filter %}active{% endif %}">{{ filter }}</button>
                            <span class="delete-filter" onclick="deleteFilter('{{ filter }}')">âœ–</span>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="filter-wrapper new-filter-wrapper">
                    <button id="new-filter-button" onclick="toggleNewFilterForm()" class="filter-button new-filter-button">New</button>
                </div>
            </div>
            <a href="{% url 'task_create' %}?filter={{ current_filter }}" class="create-task">Create new task</a>
        </div>
    </div>

    <div id="new-filter-form" class="new-filter-form" style="display: none;">
        <input type="text" id="new-filter-name" placeholder="Enter filter name" class="new-filter-input" maxlength="15">
        <button id="add-filter-button" class="add-filter-button">Add Filter</button>
    </div>

    <div class="task-list">
        {% for task in tasks %}
            <div class="task-item" data-status="{{ task.status.all|join:', ' }}">
                <p class="task-title">{{ task.title }}</p>
                <p class="task-description">{{ task.description }}</p>
                {% if task.start_time %}
                    <p class="due-date"><strong>Start time:</strong> {{ task.start_time }}</p>
                {% endif %}
                <div class="task-actions">
                    <form method="post" action="{% url 'task_complete' task.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="complete-button">Complete</button>
                    </form>
                    <a href="{% url 'task_edit' task.id %}" class="edit-button">Edit</a>
                    <form method="post" action="{% url 'task_delete' task.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="delete-button">&#128465;</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div id="alert-box" class="alert-box hidden">Maximum number of filters reached.</div>

<script>
    function toggleNewFilterForm() {
        const form = document.getElementById('new-filter-form');
        form.style.display = form.style.display === 'none' ? 'flex' : 'none';
    }

    function deleteFilter(filterName) {
        fetch(`/tasks/delete_filter/?name=${filterName}`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}})
        .then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }

    document.getElementById('add-filter-button').addEventListener('click', function() {
        const filterName = document.getElementById('new-filter-name').value;
        if (filterName && filterName.length <= 15) {
            fetch('/tasks/add_filter/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ name: filterName })
            }).then(response => response.json()).then(data => {
                if (data.status === 'ok') {
                    window.location.reload();
                } else {
                    showAlert('Failed to add filter.');
                }
            });
        }
    });

    function showAlert(message) {
        const alertBox = document.getElementById('alert-box');
        alertBox.innerText = message;
        alertBox.classList.remove('hidden');
        setTimeout(() => {
            alertBox.classList.add('hidden');
        }, 3000);
    }
</script>
{% endblock %}
